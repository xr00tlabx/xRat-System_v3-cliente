name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup MinGW
      run: |
        choco install mingw -y --no-progress
        
        # Refresh environment variables
        refreshenv
        
        # Look for MinGW in common installation paths
        $mingwPaths = @(
          "C:\ProgramData\mingw64\mingw64\bin",
          "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin",
          "C:\mingw64\bin",
          "C:\tools\mingw64\bin"
        )
        
        $foundPath = $null
        foreach ($path in $mingwPaths) {
          if (Test-Path $path) {
            $foundPath = $path
            break
          }
        }
        
        if ($foundPath) {
          echo "$foundPath" >> $env:GITHUB_PATH
          Write-Host "MinGW encontrado em: $foundPath"
          Write-Host "MinGW instalado e adicionado ao PATH"
        } else {
          Write-Host "Caminhos testados:"
          foreach ($path in $mingwPaths) {
            Write-Host "  $path - $(if (Test-Path $path) { 'Existe' } else { 'Nao encontrado' })"
          }
          throw "MinGW nao encontrado apos instalacao"
        }
      shell: powershell
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Create build directories
      run: |
        New-Item -ItemType Directory -Path "obj", "obj\utils", "obj\forms", "obj\controllers", "obj\network", "bin", "release" -Force
      shell: powershell
      
    - name: Build MinGW Release
      run: |
        echo Building MinGW release...
        mingw32-make.exe clean
        mingw32-make.exe release
        copy bin\main.exe release\xrat-mingw-x64.exe
      shell: cmd
      
    - name: Build MSVC Release
      run: |
        echo Building MSVC release...
        cl /EHsc /W3 /O2 /DNDEBUG /D_CRT_SECURE_NO_WARNINGS /Iinclude /c src/utils/AppUtils.cpp /Fo:obj/utils/AppUtils.obj
        cl /EHsc /W3 /O2 /DNDEBUG /D_CRT_SECURE_NO_WARNINGS /Iinclude /c src/utils/Config.cpp /Fo:obj/utils/Config.obj
        cl /EHsc /W3 /O2 /DNDEBUG /D_CRT_SECURE_NO_WARNINGS /Iinclude /c src/utils/WindowMonitor.cpp /Fo:obj/utils/WindowMonitor.obj
        cl /EHsc /W3 /O2 /DNDEBUG /D_CRT_SECURE_NO_WARNINGS /Iinclude /c src/network/WebSocketClient.cpp /Fo:obj/network/WebSocketClient.obj
        cl /EHsc /W3 /O2 /DNDEBUG /D_CRT_SECURE_NO_WARNINGS /Iinclude /c src/network/SocketManager.cpp /Fo:obj/network/SocketManager.obj
        cl /EHsc /W3 /O2 /DNDEBUG /D_CRT_SECURE_NO_WARNINGS /Iinclude /c src/controllers/MainController.cpp /Fo:obj/controllers/MainController.obj
        cl /EHsc /W3 /O2 /DNDEBUG /D_CRT_SECURE_NO_WARNINGS /Iinclude /c src/forms/MainForm.cpp /Fo:obj/forms/MainForm.obj
        cl /EHsc /W3 /O2 /DNDEBUG /D_CRT_SECURE_NO_WARNINGS /Iinclude /c src/main.cpp /Fo:obj/main.obj
        link obj/main.obj obj/utils/AppUtils.obj obj/utils/Config.obj obj/utils/WindowMonitor.obj obj/network/WebSocketClient.obj obj/network/SocketManager.obj obj/controllers/MainController.obj obj/forms/MainForm.obj /OUT:release/xrat-msvc-x64.exe gdi32.lib user32.lib kernel32.lib ws2_32.lib
      shell: cmd
      
    - name: Create changelog
      run: |
        $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
        $changelogContent = "# Changelog " + $tag + "`n`n"
        $changelogContent += "## Funcionalidades`n"
        $changelogContent += "- Interface Win32 nativa com arquitetura MVC`n"
        $changelogContent += "- **Cliente WebSocket nativo C++** - Comunicação WebSocket RFC 6455 completa`n"
        $changelogContent += "- **Protocolo WebSocket** - Handshake, frames, masking/unmasking`n"
        $changelogContent += "- **Thread de recebimento** - Comunicação bidirecional em tempo real`n"
        $changelogContent += "- **Sistema de configuração JSON** - URL do servidor configurável`n"
        $changelogContent += "- Monitoramento de janelas ativas em background (thread separada)`n"
        $changelogContent += "- Sistema de logging estruturado com comunicação WebSocket`n"
        $changelogContent += "- Build suportado para MinGW e MSVC`n`n"
        $changelogContent += "## Binarios Inclusos`n"
        $changelogContent += "- **xrat-mingw-x64.exe** - Compilado com MinGW/GCC (recomendado)`n"
        $changelogContent += "- **xrat-msvc-x64.exe** - Compilado com Visual Studio/MSVC`n`n"
        $changelogContent += "## Requisitos do Sistema`n"
        $changelogContent += "- Windows 7 ou superior`n"
        $changelogContent += "- Arquitetura x64`n`n"
        $changelogContent += "## Como Usar`n"
        $changelogContent += "1. Configure a URL do servidor WebSocket no arquivo config.json`n"
        $changelogContent += "2. Baixe o executavel de sua preferencia`n"
        $changelogContent += "3. Execute o programa`n"
        $changelogContent += "4. O cliente conectará automaticamente ao servidor WebSocket`n"
        $changelogContent += "5. Use os botoes da interface para interagir`n"
        $changelogContent += "6. Verifique os logs em application.log`n`n"
        $changelogContent += "## Comunicação WebSocket`n"
        $changelogContent += "O cliente implementa:`n"
        $changelogContent += "- **Protocolo WebSocket RFC 6455** - Implementação completa nativa em C++`n"
        $changelogContent += "- **Conexão automática** - Conecta ao servidor configurado na inicialização`n"
        $changelogContent += "- **Comunicação bidirecional** - Envia e recebe mensagens em tempo real`n"
        $changelogContent += "- **Thread dedicada** - Recebimento de mensagens sem bloquear interface`n"
        $changelogContent += "- **Formato JSON** - Troca de mensagens estruturadas`n`n"
        $changelogContent += "## Logs e Monitoramento`n"
        $changelogContent += "O programa automaticamente:`n"
        $changelogContent += "- Registra eventos da aplicacao`n"
        $changelogContent += "- Monitora janelas ativas a cada 2 segundos`n"
        $changelogContent += "- Salva logs detalhados para debug`n`n"
        $changelogContent += "Para mais informacoes, consulte o README.md."
        $changelogContent | Out-File -FilePath "release\CHANGELOG.md" -Encoding UTF8
        Copy-Item "README.md" "release\"
        Copy-Item ".github-copilot-instructions.md" "release\"
      shell: powershell
      
    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release/xrat-mingw-x64.exe
          release/xrat-msvc-x64.exe
          release/CHANGELOG.md
          release/README.md
          release/.github-copilot-instructions.md
        name: Release ${{ github.ref_name }}
        body_path: release/CHANGELOG.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
